// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

enum CursoStatus {
  activo
  inactivo
}

enum CompraEstado {
  pendiente
  pagado
  cancelado
  reembolsado
}

enum PagoEstado {
  pendiente
  confirmado
  rechazado
  reembolsado
}

enum MatriculaEstado {
  activo
  retirado
  completado
}

// db models
model Role {
  id          String    @id @default(uuid()) @db.Char(36)
  nombre      String    @unique
  descripcion String?
  is_active   Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  usuarios    Usuario[]
}

model Usuario {
  id               String  @id @default(uuid()) @db.Char(36)
  nombre           String
  apellido_paterno String
  apellido_materno String?
  email            String  @unique
  telefono         String?
  role_id          String
  is_active        Boolean @default(true)
  password         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role    Role     @relation(fields: [role_id], references: [id])
  compras Compra[] @relation("VendedorCompras")
}

model Cliente {
  id               String  @id @default(uuid()) @db.Char(36)
  nombre           String
  apellido_paterno String
  apellido_materno String
  telefono         String?
  email            String  @unique
  dni              String  @unique
  moodle_user_id   Int?    @unique
  credentials_sent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  compras    Compra[]
  matriculas Matricula[]
}

model Curso {
  id               String      @id @default(uuid()) @db.Char(36)
  nombre           String
  descripcion      String?
  status           CursoStatus @default(activo)
  duracion_semanas Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ediciones  Edicion[]
  matriculas Matricula[]
}

model Modalidad {
  id     String @id @default(uuid()) @db.Char(36)
  nombre String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ediciones Edicion[]
}

model Edicion {
  id                 String    @id @default(uuid()) @db.Char(36)
  curso_id           String
  fecha_inicio       DateTime? @db.Date
  fecha_finalizacion DateTime? @db.Date
  modalidad_id       String
  moodle_course_id   String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  curso     Curso      @relation(fields: [curso_id], references: [id])
  modalidad Modalidad  @relation(fields: [modalidad_id], references: [id])
  productos Producto[]
}

model Producto {
  id         String  @id @default(uuid()) @db.Char(36)
  edicion_id String
  precio     Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  edicion       Edicion         @relation(fields: [edicion_id], references: [id])
  detalleCompra DetalleCompra[]
}

model Compra {
  id           String       @id @default(uuid()) @db.Char(36)
  cliente_id   String
  vendedor_id  String?
  costo_total  Decimal      @db.Decimal(10, 2)
  estado_order CompraEstado

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cliente  Cliente  @relation(fields: [cliente_id], references: [id])
  vendedor Usuario? @relation("VendedorCompras", fields: [vendedor_id], references: [id])

  detalles DetalleCompra[]
  pagos    Pago[]
}

model DetalleCompra {
  id             String  @id @default(uuid()) @db.Char(36)
  producto_id    String
  costo_unitario Decimal @db.Decimal(10, 2)
  compra_id      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  producto Producto @relation(fields: [producto_id], references: [id])
  compra   Compra   @relation(fields: [compra_id], references: [id])
}

model Pago {
  id                 String     @id @default(uuid()) @db.Char(36)
  orden_id           String
  cantidad           Decimal    @db.Decimal(10, 2)
  estado             PagoEstado
  codigo_transaccion String?    @unique
  fecha_pago         DateTime?
  metodo_pago        String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  compra Compra @relation(fields: [orden_id], references: [id])
}

model Matricula {
  id                   String          @id @default(uuid()) @db.Char(36)
  cliente_id           String
  curso_id             String
  moodle_enrollment_id String?         @unique
  estado               MatriculaEstado
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  cliente              Cliente         @relation(fields: [cliente_id], references: [id])
  curso                Curso           @relation(fields: [curso_id], references: [id])
}
